<html>
<style>
.error {
  color:red;
}
.title {
  text-align: center;
  font-weight: 600;
}
.modal-title {
  width: 100%;
}
.body-container {
  width: 90%;
  margin: 0 auto;
}
</style>
<head>
<div class="page-header">
  <h1 class="title">Workers</h1>
</div>
</head>
<body>
<div class="body-container">
  <div class="table-responsive">
    <table id="workers-table" class="table">
      <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Name</th>
          <th scope="col">Surname</th>
          <th scope="col">Email</th>
          <th scope="col">Street Address</th>
          <th scope="col">City</th>
          <th scope="col">Country</th>
          <th scope="col">Phone Number</th>
          <th scope="col">Password Hash</th>
          <th scope="col">Job</th>
          <th scope="col">Admin</th>
        </tr>
      </thead>
      <tbody id="table_content">
      </tbody>
    </table>
  </div>

  <div class="modal fade" id="worker-register-modal" tabindex="-1" role="dialog" aria-labelledby="workerRegisterModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="worker-register-form">
          <div class="modal-header">
            <h4 class="modal-title" id="workerRegisterModalTitle">Enter new worker data
              <button type="button" style="float: right; margin-top: -1rem;" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
            </h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="fname">First Name:</label>
              <input type="text" name="fname" class="form-control" placeholder="Enter workers name" required="true"></input>
            </div>
            <div class="form-group">
              <label for="lname">Last Name:</label>
              <input type="text" name="lname" class="form-control" placeholder="Enter worker surname" required="true"></input>
            </div>
            <div class="form-group">
              <label>Email address</label>
              <input type="email" class="form-control" aria-describedby="emailHelp" placeholder="Enter email" required="true">
              <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
            </div>
            <div class="form-group">
              <label for="address">Address:</label>
              <input type="text" name="address" class="form-control" placeholder="Enter worker address" required="true"></input>
            </div>
            <div class="form-group">
              <label for="city">City:</label>
              <input type="text" name="city" class="form-control" placeholder="Enter worker city" required="true"></input>
            </div>
            <div class="form-group">
              <label for="country">Country:</label>
              <input type="text" name="country" class="form-control" placeholder="Enter worker country" required="true"></input>
            </div>
            <div class="form-group">
              <label for="phone_number">Phone number:</label>
              <input type="text" name="phone_number" class="form-control" placeholder="Enter worker phone number" required="true"></input>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" class="form-control" placeholder="Password" required="true"></input>
            </div>
            <div class="form-group">
              <label for="job">Job:</label>
              <input type="text" name="job" class="form-control" placeholder="Enter job title" required="true"></input>
            </div>
            <div class="form-group">
              <label>Admin</label>
              <select name="admin" class="form-control" required="true">
                <option value="" disabled selected>Choose your option</option>
                <option value=1>YES</option>
                <option value=0>NO</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-success">Register</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="worker-edit-modal" tabindex="-1" role="dialog" aria-labelledby="workerEditModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="worker-edit-form">
          <div class="modal-header">
            <h4 class="modal-title" id="workerEditModalTitle">Enter worker data
              <button type="button" style="float: right; margin-top: -1rem;" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
            </h4>
          </div>
          <div class="modal-body">
            <div>
              <input type="hidden" name="id" class="form-control"></input>
            </div>
            <div>
              <label for="fname">First Name:</label>
              <input type="text" name="fname" class="form-control" placeholder="Enter worker name" required="true"></input>
            </div>
            <div>
              <label for="lname">Last Name:</label>
              <input type="text" name="lname" class="form-control" placeholder="Enter worker surname" required="true"></input>
            </div>
            <div class="form-group">
              <label>Email address</label>
              <input type="email" class="form-control" aria-describedby="emailHelp" placeholder="Enter email" required="true">
              <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
            </div>
            <div>
              <label for="address">Address:</label>
              <input type="text" name="address" class="form-control" placeholder="Enter worker address" required="true"></input>
            </div>
            <div>
              <label for="city">City:</label>
              <input type="text" name="city" class="form-control" placeholder="Enter worker city" required="true"></input>
            </div>
            <div>
              <label for="country">Country:</label>
              <input type="text" name="country" class="form-control" placeholder="Enter worker country" required="true"></input>
            </div>
            <div>
              <label for="phone_number">Phone number:</label>
              <input type="text" name="phone_number" class="form-control" placeholder="Enter worker phone number" required="true"></input>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" class="form-control" placeholder="Password" required="true"></input>
            </div>
            <div>
              <label for="job">Job:</label>
              <input type="text" name="job" class="form-control" placeholder="Enter job title" required="true"></input>
            </div>
            <div>
              <label>Admin</label>
              <select name="admin" class="form-control" required="true">
                <option value="" disabled selected>Choose your option</option>
                <option value=1>YES</option>
                <option value=0>NO</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-success">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirm-modal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="confirm-form">
          <div class="modal-header" style="text-align: center;">
            <h4 class="modal-title" id="confirm-modal-label" style="display:inline-block;">Are you sure?</h4>
          </div>
          <div class="modal-footer" style="border: none;">
            <button type="button" class="btn btn-success" onclick="cancel_delete_modal()">No</button>
            <button type="submit" class="btn btn-danger">Delete worker</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
</body>

<script>
function get_workers() {
  $.ajax({
    url: "rest/workers",
    type: "GET",
    beforeSend: function(xhr) {
      xhr.setRequestHeader('authorization', 'Bearer ' +  localStorage.getItem("user_token"));
    },
    success: function( data ) {
      var dataSet = [];
      for (var i = 0; i < data.length; i++) {
        dataSet.push([
          data[i].id,
          data[i].name,
          data[i].surname,
          data[i].email,
          data[i].street_address,
          data[i].city,
          data[i].country,
          data[i].phone_number,
          data[i].password,
          data[i].job,
          data[i].admin
        ]);
      }

      $("#workers-table").DataTable({
        responsive: true,
        data: dataSet,
        columns: [
          {title: "ID", visible:false},
          {title: "Name"},
          {title: "Surname"},
          {title: "Email"},
          {title: "Street Address"},
          {title: "City"},
          {title: "Country"},
          {title: "Phone Number"},
          {title: "Password Hash"},
          {title: "Job"},
          {title: "Admin"}
        ],
        dom: 'Bfrtip',
        buttons: [
          {
            text: 'Delete worker',
            action: function ( e, dt, button, config ) {
              if ($('#workers-table').DataTable().row('.selected').data()) {
                var id = $('#workers-table').DataTable().row('.selected').data()[0];
                confirm_modal_show(id);
              } else {
                toastr.error("Please select a worker");
              }
            }
          },
          {
            text: 'Add new worker',
            action: function ( e, dt, button, config ) {
              open_worker_register_modal();
            }
          },
          {
            text: 'Update worker',
            action: function ( e, dt, button, config ) {
              if ($('#workers-table').DataTable().row('.selected').data()) {
                  var id = $('#workers-table').DataTable().row('.selected').data()[0];
                  open_worker_edit_modal(id);
              } else {
                toastr.error("Please select a worker");
              }
            }
          }
        ],
        "pageLength": 5,
        "lengthMenu": [2, 5, 10, 25, 50, "All"]
      });
    }
  })
}

function confirm_modal_show(i) {
  $("#confirm-modal").modal('show');
  localStorage.setItem('remove_worker_id', i);
}

$('#confirm-form').validate({
  submitHandler: function(form) {
    var id = localStorage.getItem('remove_worker_id');
    delete_worker(id);
    localStorage.removeItem('remove_worker_id');
    $("#confirm-modal").modal('hide');
  }
});

function cancel_delete_modal() {
  localStorage.removeItem('remove_worker_id');
  $("#confirm-modal").modal('hide');
}

function delete_worker(id) {
  $.ajax({
    url: 'rest/user/'+id,
    method: 'DELETE',
    success: function(result) {
      toastr.success('Deleted');
      $('#workers-table').DataTable().clear().destroy();
      get_workers();
    },
    error: function() {
      toastr.success('Not deleted');
    }
  });
}

$('#worker-register-form').validate({
  submitHandler: function(form) {
    var user = {
      name: $('#worker-register-form input[name="fname"]').val(),
      surname: $('#worker-register-form input[name="lname"]').val(),
      email: $('#worker-register-form input[type="email"]').val(),
      street_address: $('#worker-register-form input[name="address"]').val(),
      city: $('#worker-register-form input[name="city"]').val(),
      country: $('#worker-register-form input[name="country"]').val(),
      phone_number: $('#worker-register-form input[name="phone_number"]').val(),
      password: $('#worker-register-form input[type="password"]').val(),
      job: $('#worker-register-form input[name="job"]').val(),
      admin: $('#worker-register-form select[name="admin"]').val()
    }

    $.post( "rest/user", user ).done(function(data) {
      toastr.success('You have added a new worker');
      $('#worker-register-modal').modal('toggle');
      $('#workers-table').DataTable().clear().destroy();
      get_workers();
    }).fail(function(error) {
      toastr.error(error.responseText);
    });
  }
});

function open_worker_register_modal() {
  $('#worker-register-modal').modal('toggle');
}

function open_worker_edit_modal(id) {
  $.ajax({
    url: 'rest/user/'+id,
    method: 'GET',
    beforeSend: function(xhr) {
      xhr.setRequestHeader('authorization', 'Bearer ' +  localStorage.getItem("user_token"));
    },
    success: function(data){
      $('#worker-edit-modal').modal('toggle');
      $('#worker-edit-form input[name="fname"]').val(data.name);
      $('#worker-edit-form input[name="lname"]').val(data.surname);
      $('#worker-edit-form input[name="id"]').val(data.id);
      $('#worker-edit-form input[type="email"]').val(data.email);
      $('#worker-edit-form input[name="city"]').val(data.city);
      $('#worker-edit-form input[name="country"]').val(data.country);
      $("#worker-edit-form input[name=address]").val(data.street_address);
      $('#worker-edit-form input[type="password"]').val(data.password);
      $('#worker-edit-form select[name="admin"]').val(data.admin);
      $('#worker-edit-form input[name="job"]').val(data.job);
      $('#worker-edit-form input[name="phone_number"]').val(data.phone_number);
    },
    error: function(){
      toastr.error(error.responseText);
    }
  });
}

$('#worker-edit-form').validate({
  submitHandler: function(form) {
    var user = {
      id: $('#worker-edit-form input[name="id"]').val(),
      name: $('#worker-edit-form input[name="fname"]').val(),
      surname: $('#worker-edit-form input[name="lname"]').val(),
      email: $('#worker-edit-form input[type="email"]').val(),
      street_address: $('#worker-edit-form input[name="address"]').val(),
      city: $('#worker-edit-form input[name="city"]').val(),
      country: $('#worker-edit-form input[name="country"]').val(),
      phone_number: $('#worker-edit-form input[name="phone_number"]').val(),
      password: $('#worker-edit-form input[type="password"]').val(),
      job: $('#worker-edit-form input[name="job"]').val(),
      admin: $('#worker-edit-form select[name="admin"]').val()
    }

    $.post( "rest/users", user ).done(function(data) {
      toastr.success('You have updated a worker');
      $('#worker-edit-modal').modal('toggle');
      $('#workers-table').DataTable().clear().destroy();
      get_workers();
    }).fail(function(error) {
      toastr.error(error.responseText);
    });
  }
});

$(document).ready(function() {
  get_workers();
  $('#table_content').on( 'click', 'tr', function () {
    if ($(this).hasClass('selected')) {
      $(this).removeClass('selected');
    } else {
      $('.selected').toggleClass('selected');
      $(this).toggleClass('selected');
    }
  });
});
</script>
</html>